<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music VR - Upload & Analyze</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index2.css') }}">

    <!-- A-Frame MUST be loaded before any A-Frame components -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- Environment Component Library -->
    <script
        src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

    <!-- Shared A-Frame Custom Components -->
    <script src="{{ url_for('static', filename='js/components/skyController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/GradientShader.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/multiColorFloor.js') }}"></script>

    <!-- Forest & Sky Components -->
    <script src="{{ url_for('static', filename='js/components/forestController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/moonController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/starsController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/stageController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/boatController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/cameraController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modelColor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/waterRipple.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/lanterns.js') }}"></script>

    <!-- Ocean Components -->
    <script src="{{ url_for('static', filename='js/components/ship-y-controller.js') }}"></script>

    <!-- Room Components -->
    <script src="{{ url_for('static', filename='js/components/room-objects.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/window-view-controller.js') }}"></script>

    <!-- Urban Components (Using module type if needed, but normally just script for a-frame) -->
    <script type="module" src="{{ url_for('static', filename='js/components/urban-environment.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/components/city-generator.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/components/street-lights.js') }}"></script>
</head>

<body>
    <!-- Temporary Test Buttons -->
    <div id="test-buttons" style="position: fixed; top: 10px; left: 10px; z-index: 9999; display: flex; gap: 10px;">
        <button id="btn-test-urban" style="padding: 10px; cursor: pointer;">Test Urban</button>
        <button id="btn-test-ocean" style="padding: 10px; cursor: pointer;">Test Ocean</button>
        <button id="btn-test-forest" style="padding: 10px; cursor: pointer;">Test Forest</button>
        <button id="btn-test-room" style="padding: 10px; cursor: pointer;">Test Room</button>
    </div>

    <!-- UI Layer -->
    <div id="ui-layer" style="display: none;">
        <div class="container">
            <h1>Music Analysis</h1>

            <div class="upload-area" id="drop-zone">
                <div class="upload-icon">ðŸŽµ</div>
                <p>Drag & Drop your MP3 file here</p>
                <p style="font-size: 0.8em; opacity: 0.6;">or click to browse</p>
                <input type="file" id="file-input" accept=".mp3,audio/*" style="display: none;">
            </div>

            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p id="loading-text">Analyzing... Extracting metadata, running Shazam, and finding lyrics...</p>
            </div>

            <div class="error-msg" id="error-msg" style="display: none;"></div>

            <div class="result-section" id="result-section" style="display: none;">
                <div class="track-info">
                    <img src="" alt="Cover Art" class="cover-art" id="cover-art">
                    <div class="meta-text">
                        <h2 id="track-title">Unknown Title</h2>
                        <p><strong>Artist:</strong> <span id="track-artist">Unknown Artist</span></p>
                        <p><strong>Album:</strong> <span id="track-album">-</span></p>
                        <p><strong>Source:</strong> <span id="data-source">Shazam / Genius</span></p>
                    </div>
                </div>

                <h3>Lyrics (Verify & Edit)</h3>
                <textarea class="lyrics-box" id="lyrics-box" rows="12"
                    style="width: 100%; border-radius: 8px; padding: 10px; font-family: inherit; resize: vertical;"></textarea>

                <button id="confirm-btn"
                    style="display: none; padding: 10px 20px; font-size: 16px; margin-top: 15px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px;">
                    Play & Start VR Generation
                </button>
            </div>
        </div>
    </div>

    <!-- VR Layer (Hidden initially) -->
    <div id="vr-layer" style="display: block;">
        <a-scene music-manager>
            <a-assets>
                <!-- Urban -->
                <a-asset-item id="building01"
                    src="/static/assets/3Dmodels/buildings/building_01/scene.gltf"></a-asset-item>
                <a-asset-item id="building02"
                    src="/static/assets/3Dmodels/buildings/building_02/scene.gltf"></a-asset-item>
                <a-asset-item id="building03"
                    src="/static/assets/3Dmodels/buildings/building_03/scene.gltf"></a-asset-item>
                <a-asset-item id="building05"
                    src="/static/assets/3Dmodels/buildings/building_05/scene.gltf"></a-asset-item>
                <a-asset-item id="building06"
                    src="/static/assets/3Dmodels/buildings/building_06/scene.gltf"></a-asset-item>
                <a-asset-item id="street-light" src="/static/assets/3Dmodels/street_light/scene.gltf"></a-asset-item>
                <!-- Ocean -->
                <img id="waterNormal"
                    src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/water/Water_1_M_Normal.jpg">
                <!-- Forest -->
                <img id="sky" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/city.jpg">
            </a-assets>

            <a-entity id="environment-root"></a-entity>
        </a-scene>
    </div>

    </a-scene>
    </div>

    <!-- Custom Scripts -->
    <!-- Environment Injectors -->
    <script src="{{ url_for('static', filename='js/environments/urbanInjector.js') }}"></script>
    <script src="{{ url_for('static', filename='js/environments/oceanInjector.js') }}"></script>
    <script src="{{ url_for('static', filename='js/environments/forestInjector.js') }}"></script>
    <script src="{{ url_for('static', filename='js/environments/roomInjector.js') }}"></script>

    <!-- Main Injector -->
    <script src="{{ url_for('static', filename='js/EnvironmentInjector.js') }}"></script>
    <script src="{{ url_for('static', filename='js/AudioStateManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/upload.js') }}"></script>

    <!-- Audio Playback Controller -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/audioPlaybackController.css') }}">
    <script src="{{ url_for('static', filename='js/components/audioPlaybackController.js') }}"></script>

    <!-- Test Script -->
    <script>
        document.getElementById('btn-test-urban').addEventListener('click', () => {
            envInjector.inject('urban');
        });
        document.getElementById('btn-test-ocean').addEventListener('click', () => {
            envInjector.inject('ocean');
        });
        document.getElementById('btn-test-forest').addEventListener('click', () => {
            envInjector.inject('forest');
        });
        document.getElementById('btn-test-room').addEventListener('click', () => {
            envInjector.inject('room');
        });
    </script>
</body>

</html>