<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Music VR</title>
    <!-- A-Frame CDN -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- Custom Scripts -->
    <script src="{{ url_for('static', filename='js/components/forestController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/moonController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/starsController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/stageController.js') }}"></script>
    <!-- New Scene Scripts -->
    <script src="{{ url_for('static', filename='js/components/waterController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/boatController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/cameraController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/modelColor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/waterRipple.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/lanterns.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/skyController.js') }}"></script>
    <script src="{{ url_for('static', filename='js/GradientShader.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/multiColorFloor.js') }}"></script>

</head>

<body>
    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; gap: 10px;">
        <button id="btn-morning"
            style="padding: 10px; background: #87CEEB; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Morning</button>
        <button id="btn-evening"
            style="padding: 10px; background: #FF7F50; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Evening</button>
        <button id="btn-night"
            style="padding: 10px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Night</button>
    </div>
    <a-scene fog="type: exponential; color: #050510; density: 0.002">

        <!-- Moon (Keep existing) -->
        <a-entity id="moon" gltf-model="url({{ url_for('static', filename='assets/3Dmodels/moon/scene_fixed.gltf') }})"
            position="50 150 -150" scale="1 1 1" moon-controller>
        </a-entity>

        <!-- Assets -->
        <a-assets>
            <img id="sky" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/city.jpg">
        </a-assets>

        <!-- Environment -->
        <a-entity sky-controller></a-entity>
        <a-sky
            material="shader: gradient-shader; topColor: #020205; bottomColor: #050510; offset: 400; exponent: 0.6"></a-sky>
        <a-entity star-system="count: 5000; radius: 400; color: #FFF"></a-entity>

        <!-- Forest (Background) -->
        <a-entity
            forest-generator="count: 40; treeModel: url({{ url_for('static', filename='assets/3Dmodels/pine_tree_fixed.glb') }}); autoStart: true">
        </a-entity>


        <!-- NEW: Water Surface (Parent for draining animation) -->
        <a-entity water-helper="width: 1000; height: 1000" position="0 -20 0">
            <!-- Boat Nested Inside to sink with Water -->
            <a-entity id="boat" boat-controller="color: #00FF00" water-ripple position="0 0 0">
                <!-- Decoration can go here, but NOT the camera -->
            </a-entity>
        </a-entity>

        <a-entity lanterns="count: 100; range: 200; speed: 0.8; color: #ffaa00"></a-entity>

        <!-- Player Camera (Detached from boat hierarchy to avoid wiggle) -->
        <!-- target: #boat; offset: 0 1.6 0.5 (slightly back); copyRotationY: false (stable horizon) -->
        <a-entity camera-controller="target: #boat; offset: 0 1.6 0.5; copyRotationY: true" position="0 1.6 0"
            rotation="0 180 0">
            <!-- Added wrapper for rotation offset if needed, but simple follow is often enough -->
            <a-camera look-controls wasd-controls="fly: false"></a-camera>
        </a-entity>


        <!-- Lighting -->
        <a-light type="ambient" color="#222"></a-light>
        <!-- Moonlight -->
        <a-light type="directional" position="20 50 -20" color="#aaccff" intensity="0.6"></a-light>
        <!-- Lantern Warmth -->
        <a-light type="point" position="0 5 0" color="#ffaa00" intensity="0.5" distance="50"></a-light>


        <!-- Floor (Multi-Color Capable) -->
        <a-plane position="0 -5 0" rotation="-90 0 0" width="1000" height="1000"
            multi-color-floor="preset: none"></a-plane>


    </a-scene>
</body>
<script>
    const forest = document.querySelector('[forest-generator]');
    const moon = document.querySelector('#moon');
    const lanterns = document.querySelector('[lanterns]');

    // Trigger Moon Growth
    setTimeout(() => {
        if (moon) moon.emit('start-growth');
    }, 1000);

    // Trigger Forest Growth
    setTimeout(() => {
        if (forest) forest.emit('start-growth');
    }, 500);

    // Trigger Lanterns (Lanterns are now nested in water, so they rise with it)
    const water = document.querySelector('[water-helper]');

    // SEQUENCE:
    // 0s: Hidden at Y=-20
    // 10s: Rise to Y=0 (Start Fill)
    // 20s: Drain to Y=-20 (Start Drain)

    setTimeout(() => {
        console.log("Starting Lanterns and Water Rise...");
        if (lanterns) lanterns.emit('start-lanterns'); // Activate lantern logic
        if (water) water.emit('start-fill');           // Rise up
    }, 10000);

    setTimeout(() => {
        console.log("Returning Water (Drain)...");
        if (water) water.emit('start-drain');          // Drain down
    }, 20000); // 10s after rising (total 20s)

    // Wait for scene to load before emitting events to ensure components are ready
    document.querySelector('a-scene').addEventListener('loaded', function () {
        // Sky Controller UI Logic
        const skyCtrl = document.querySelector('[sky-controller]');
        if (skyCtrl) {
            console.log("Emitting set-morning...");
            skyCtrl.emit('set-morning');
        }

        const floorCtrl = document.querySelector('[multi-color-floor]');
        if (floorCtrl) {
            console.log("Emitting set-floor-snow...");
            floorCtrl.emit('set-floor-snow');
        }
    });

    // Button Listeners (can be attached immediately as they depend on user interaction later)
    const skyCtrl = document.querySelector('[sky-controller]');
    if (skyCtrl) {
        document.getElementById('btn-morning').addEventListener('click', () => skyCtrl.emit('set-morning'));
        document.getElementById('btn-evening').addEventListener('click', () => skyCtrl.emit('set-evening'));
        document.getElementById('btn-night').addEventListener('click', () => skyCtrl.emit('set-night'));
    }

</script>

</html>